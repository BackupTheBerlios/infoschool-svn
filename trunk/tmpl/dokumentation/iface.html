<p>
 Schnittstellen: alle global zur Verfügung stehenden Funktionen.
</p>
<p>
 <b>(string) path_rm_last(string)</b> entfernt aus einem String alles hinter dem letzten '/'.<br>
 <b>(string) path_clean(string)</b> entfernt unnötige Umwege ('./' und '../') aus Pfaden.<br>
 <b>(string) path_absolute(string='')</b> f&uuml;gt das aktuelle Verzeichnis im Dateisystem am Anfang an.<br>
 <b>(string) get_face(string,array=array,string='')</b> gibt den Inhalt einer Datei zur&uuml;ck. Der erste String ist der Dateiname, das Array kann Strings enthalten, die ersetzt werden sollen ('gesucht'=>'ersatz') und &uuml;ber den zweiten String kann man ein Verzeichnis w&auml;hlen, aus dem nicht ausgebrochen werden darf. Normalerweise ist dies das aktuelle Verzeichnis.
 <b>(string) sessionurl(string)</b>: bei g&uuml;ltigem Login wird die Session-ID an die URL geh&auml;ngt.<br>
 <b>(void) redirect(string='',array=array,string='')</b> leitet den Browser zu einer URL (erster String) weiter. Der URL k&ouml;nnen Variablen &uuml;ber das Array und ein interner HTML-Link &uuml;ber den zweiten String &uuml;bergeben werden.
 <b>(string) text2html(string)</b> erwartet UTF-8-Text und gibt HTML in ASCII wieder.<br>
 <b>(string) code_url(string)</b> f&uuml;gt ein 'http://' an einen String, falls kein '://' gefunden wird.<br>
 <b>(string) format_msg(string)</b> erwartet UTF-8-Text, gibt HTML in ASCII wieder und interpretiert dabei Codetags, die in $GLOBALS['code_html'] definiert sind. In $GLOBALS['code_func'] kann man Funktionen nennen, durch die Taginhalte manipuliert werden sollen (s. /var.php).<br>
 <b>(string) html2text(string)</b> wandelt HTML-Code in normale Sonderzeichen um (&amp;auml; => &auml;).<br>
 <b>(string) html2textarea(string)</b> kehrt sozusagen format_msg() um.<br>
 <b>(string) htmlformat_titel(array)
</p>


<?php

 // formatiert alle Titel mit ' - ' als Trennzeichen
 function htmlformat_titel($t){
  $titel = $t[0];
  for($i=1;$i<sizeof($t);$i++){
   $titel.= ' - '.$t[$i];
  }
  return $titel;
 }

 // formatiert link-Tags für den HTML-HEAD
 function htmlformat_nav($root){
  global $html_nav;
  if(sizeof($html_nav)>0){
   $nav = '';
   foreach($html_nav as $rel => $n){
    $nav.= '<link rel="'.$rel.'" href="'.sessionurl($n[0]).'" title="'.$n[1].'">'."\n";
   }
   return $nav;
  }
 }

 // gibt alle Links zu den CSS-Stylesheet-Dateien zurück
 function htmlformat_css($root){
  $dirs = sizeof(explode('/',$root));
  $css = '';
  $r = '';
  for($i=0;$i<$dirs;$i++){
   $css.= '<link rel="stylesheet" type="text/css" href="'.$r.'style.css">'."\n";
   $r = '../'.$r;
  }
  return $css;
 }

 function select_js($root){
  $dir = opendir($root.'js/');
  while($datei = readdir($dir)){
   if(substr($datei,-10) == '.select.js'){
    $js[] = $datei;
   }
  }
  closedir($dir);
  $anz = sizeof($js);
  if($anz>0){
   if($anz>1){
    srand((double)microtime()*1000000);
    $i = rand(0,($anz-1));
   }
   else{
    $i = 0;
   }
   return $root.'js/'.$js[$i];
  }
  else return '';
 }

 // formatiert einen Menüpunkt
 function htmlformat_menuitem($root,$s,$u,$c){
  $v['%sign%'] = $s;
  $v['%url%'] = $u;
  $v['%caption%'] = $c;
  $a = path_absolute($u);
  $b = path_absolute($root.substr($_SERVER['REQUEST_URI'],1));
  if($a==$b) $item = get_face($root.'menulinkv.html',$v);
  else $item = get_face($root.'menulink.html',$v);
  return $item;
 }

 // rekursive Funktion, gibt zusammengehörige Menüpunkte zurück
 // und ruft sich für Untermenüs wieder auf
 function get_menuitem($root,$url,$caption='',$s=''){
  $item = '';
  if(is_array($url) && sizeof($url)>0){
   if($caption){
    $item = htmlformat_menuitem($root,$s.'++',$url['0'],$caption);
    unset($url['0']);
   }
   foreach($url as $c => $u){
    $item.= get_menuitem($root,$u,$c,'&#160;'.$s);
   }
  }
  else{
   $item = htmlformat_menuitem($root,$s.'+-',$url,$caption);
  }
  return $item;
 }

 // gibt alle Überschriften in HTML zurück
 function htmlformat_headline(){
  global $html_headline;
  $headlines = '';
  for ($i=1;$i<sizeof($html_headline);$i++){
   $headlines.= '<h'.$i.'>'.$html_headline[$i].'</h'.$i.'>'."\n";
  }
  return $headlines;
 }

 // gibt ein Menü zum Login zurück
 function htmlformat_login($root){
  $vorname = '';
  $nachname = '';
  $passwd = '';
  $speichern = '';
  $autologin = '';
  if(isset($_COOKIE['vorname'])) $vorname = $_COOKIE['vorname'];
  if(isset($_COOKIE['nachname'])) $nachname = $_COOKIE['nachname'];
  if(isset($_COOKIE['passwd'])) $passwd = $_COOKIE['passwd'];
  if(isset($_COOKIE['speichern'])) $speichern = $_COOKIE['speichern'];
  if(isset($_COOKIE['autologin'])) $autologin = $_COOKIE['autologin'];
  if(isset($_POST['vorname'])) $vorname = $_POST['vorname'];
  if(isset($_POST['nachname'])) $nachname = $_POST['nachname'];
  if(isset($_POST['passwd'])) $passwd = $_POST['passwd'];
  if(isset($_POST['speichern'])) $speichern = $_POST['speichern'];
  if(isset($_POST['autologin'])) $autologin = $_POST['autologin'];
  if(isset($_POST['origin'])) $origin = $_POST['origin'];
  else $origin = $_SERVER['PHP_SELF'];
  if(isset($_COOKIE['userid']))$rm_login = '<a href="'.$root.'rm_login.php?origin='.$origin.'">'.htmlformat_symbol('rm','Logindaten l&ouml;schen').'</a>';
  else $rm_login = '';
  $loginvar['%root%'] = $root;
  $loginvar['%vorname%'] = $vorname;
  $loginvar['%nachname%'] = $nachname;
  $loginvar['%passwd%'] = $passwd;
  $loginvar['%speichern%'] = $speichern;
  $loginvar['%autologin%'] = $autologin;
  $loginvar['%origin%'] = $origin;
  $loginvar['%rm_login%'] = $rm_login;
  return get_face($root.'login.html',$loginvar);
 }

 // gibt Messages einer Person wieder; die man bekommen hat, die man versendet hat, neue Messages
 function get_msgs_number($pid){
  $mc = get_mc();
  $nmysql = mysql_query('select count(msg.id) from msg where msg.status&6=6 and msg.oid='.$pid);
  mysql_close($mc);
  $narray = mysql_fetch_row($nmysql);
  return $narray[0];
 }

 // gibt die Anzahl neuer Posts in den Foren zurück
 function get_neu_post_zahl($pid){
  $q = 'select count(distinct forum_post.id)';
  $q.= ' from forum,forum_thread,forum_post';
  $q.= ' left join forum_recht_p on forum.id=forum_recht_p.fid and forum_recht_p.pid="'.$pid.'"';
  $q.= ' left join forum_recht_g on forum_recht_p.recht is null and forum.id=forum_recht_g.fid';
  $q.= ' left join pg on forum_recht_g.recht is not null and forum_recht_g.gid=pg.gid and pg.pid="'.$pid.'"';
  $q.= ' where forum.id=forum_thread.forum';
  $q.= '  and forum_thread.id=forum_post.thread';
  $q.= '  and (forum_recht_p.recht&1=1 or (forum_recht_g.recht&1=1 and pg.gid is not null))';
  $q.= '  and forum_post.datum>="'.$_SESSION['last_login'].'"';
  $q.= '  and forum_post.aid!="'.$pid.'"';
  get_mc();
  $anz_query = mysql_query($q);
  mysql_close();
  list($anz) = mysql_fetch_row($anz_query);
  return $anz;
 }

 // gibt Informationen über den Login zurück
 function htmlformat_loggedin($root){
  $antrag = '';
  $messages = '';
  $posts = '';
  $meldungen = '';
  $errors = '';
  if($_SESSION['admin']){
   $pantrag = sizeof(get_neu_account());
  }
  $gantrag = sizeof(get_neu_pg($_SESSION['userid']));
  if(($pantrag+$gantrag)>0){
   $antrag = '<div class="menu">';
   $antrag.= '<b>Neue&nbsp;Antr&auml;ge:</b><br>';
   if($pantrag)
    $antrag.= '<a href="'.$root.'benutzer/neu_person.php">Personen</a>: '.$pantrag.'<br>';
   if($gantrag)
    $antrag.= '<a href="'.$root.'benutzer/neu_pg.php">Gruppen</a>: '.$gantrag;
   $antrag.= '</div>';
  }
  $msg = get_msgs_number($_SESSION['userid']);
  if($msg>0){
   $messages = '<div class="menu"><a href="'.$root.'messages/?s=6">Neue&#160;Messages</a>:&#160;'.$msg.'</div>';
  }
  $pzahl = get_neu_post_zahl($_SESSION['userid']);
  if($pzahl>0){
   $posts = '<div class="menu"><a href="'.$root.'foren/">Neue Posts</a>: '.$pzahl.'</div>';
  }
  if(isset($_SESSION['meldungen']) && is_array($_SESSION['meldungen'])){
   while (list ($key, $val) = each ($_SESSION['meldungen'])) {
    $meldungen .= '<div class="menu">'.$val.'</div>';
   }
   $_SESSION['meldungen'] = array();
  }
  if(isset($_SESSION['error']) && is_array($_SESSION['error']) && sizeof($_SESSION['error'])>0){
   foreach($_SESSION['error'] as $i => $error){
    $errors.= '<div class="menu"><font color="#ff0000">'.$error.'</font></div>';
   }
   $_SESSION['error'] = array();
  }
  $v['%name%'] = $_SESSION['name'];
  $v['%pfad%'] = $root.'benutzer/view_person.php';
  $v['%datum%'] = htmlformat_datum($_SESSION['last_login']);
  $v['%root%'] = $root;
  $v['%file%'] = $_SERVER['PHP_SELF'];
  $v['%antrag%'] = $antrag;
  $v['%messages%'] = $messages;
  $v['%errors%'] = $errors;
  $v['%posts%'] = $posts;
  $v['%meldungen%'] = $meldungen;
  return get_face($root.'loggedin.html',$v);
 }


 function get_scr($art = 'scr_delay')
 {
   if(session_is_registered('userid'))
   {
    $mc = get_mc();
    $result = mysql_query('select scr_wait, scr_delay from person where id="'.$_SESSION['userid'].'"');
    mysql_close($mc);
    $return = mysql_fetch_array($result);
   }
   else
   {
    $return['scr_delay'] = 1000;
    $return['scr_wait'] = 0;
   }
 return $return[$art];
 }


 // gibt das allgemeine Layout zurück
 function face($inhalt=''){
  header('Content-Type: text/html;charset=utf-8');
  header('Expires: Sun, 15 Nov 1987 23:50:30 GMT');
  header('Last-Modified: '.gmdate('D, d M Y H:i:s').' GMT');
  header('Cache-Control: no-cache, must-revalidate');
  header('Pragma: no-cache');
  global $root;
  global $html_titel;
  global $html_menu;
  $vars['%inhalt%'] = $inhalt;
  $vars['%root%'] = $root;
  $vars['%nav%'] = htmlformat_nav($root);
  $vars['%css%'] = htmlformat_css($root);
  $vars['%titel0%'] = $html_titel[0];
  $vars['%titel%'] = htmlformat_titel($html_titel);
  $vars['%scr_delay%'] = get_scr('scr_delay');
  $vars['%scr_wait%'] = get_scr('scr_wait');
  $vars['%javascript%'] = select_js($root);
  $vars['%menu%'] = get_menuitem($root,$html_menu);
  $vars['%headline%'] = htmlformat_headline();
  if(session_is_registered('userid')){
   $vars['%login%'] = htmlformat_loggedin($root);
  }
  else{
   $vars['%login%'] = htmlformat_login($root);
  }
  $face = get_face($root.'face.html',$vars);
  return $face;
 }

 // gibt einen Text mit Link zur Anmeldung zurück
 function get_anmeldung_link(){
  $pfad = $GLOBALS['root'];
  $text = get_face($pfad.'anmeldung_link.html',array('%pfad%'=>$pfad.'benutzer/neu_antrag.php'));
  return $text;
 }

 // gibt den Standard-Mailbody zurück
 function get_mailbody($name,$message,$url=''){
  $v['%name%'] = $name;
  $v['%message%'] = $message;
  $v['%url%'] = $url;
  return get_face($GLOBALS['root'].'mail.txt',$v);
 }

 // gibt ein Formular zurück
 function get_form($input='',$titel='Senden',$file='',$align='left'){
  if($file=='') $file = $_SERVER['PHP_SELF'];
  $v['%input%'] = $input;
  $v['%buttontitel%'] = $titel;
  $v['%ziel%'] = $file;
  $v['%align%'] = $align;
  return get_face($GLOBALS['root'].'form.html',$v);
 }

 // stellt eine Verbindung zur MySQL-Datenbank her
 // und gibt die Verbindungskennung zurück
 function get_mc(){
  include $GLOBALS['root'].'../mysql_infoschool.php';
  $mc = mysql_connect($mysql_server,$mysql_user,$mysql_passwd);
  mysql_select_db($mysql_db);
  return $mc;
 }

 // registriert eine Variable und weist ihr bei Erfolg einen Wert zu
 function sessreg($name,$value=false){
  if(!session_is_registered($name)){
   if(!session_register($name)){
    echo 'Variable '.$name.' konnte nicht registriert werden.';
    exit;
   }
  }
  $_SESSION[$name] = $value;
 }

 function load_opt(){
  global $cookieopt;
  for($i=0;$i<sizeof($cookieopt);$i++){
   if(isset($_COOKIE[$cookieopt[$i]])){
    sessreg($cookieopt[$i],$_COOKIE[$cookieopt[$i]]);
   }
  }
 }

 // logged einen User ein und leitet einen auf die vorige Seite weiter
 function login($c=false){
  $q = 'select person.id,person.passwd,person.vorname,person.nachname,person.last_login,admin.pid from person';
  $q.= ' left join admin on person.id=admin.pid where person.passwd=';
  if($c || (isset($_COOKIE['passwd']) && $_COOKIE['passwd'] == $_POST['passwd'])) $q.= '"'.$_COOKIE['passwd'].'"';
  else $q.= 'password("'.$_POST['passwd'].'")';
  $q.= ' and';
  if($c) $q.= ' person.id="'.$_COOKIE['userid'].'"';
  else{
   $q.= ' person.nachname="'.text2html($_POST['nachname']).'"';
   if(strlen($_POST['vorname'])>0) $q.= ' and person.vorname="'.text2html($_POST['vorname']).'"';
  }
  $mc = get_mc();
  $row = mysql_query($q);
  $anz = mysql_num_rows($row);
  if($anz == 1){
   $prow = mysql_fetch_array($row);
   mysql_query('update person set last_login=now() where id="'.$prow['id'].'";');
   mysql_close($mc);
   session_start();
   sessreg('userid',$prow['id']);
   sessreg('vorname',$prow['vorname']);
   sessreg('nachname',$prow['nachname']);
   sessreg('name',$prow['vorname'].' '.$prow['nachname']);
   sessreg('last_login',$prow['last_login']);
   if($prow['id']==$prow['pid'])sessreg('admin',true);
   else sessreg('admin',false);
   load_opt();
   if(isset($_POST['speichern'])){
    setcookie('userid',$prow['id'],strtotime('+3 months'),'/');
    setcookie('passwd',$prow['passwd'],strtotime('+3 months'),'/');
    setcookie('vorname',$prow['vorname'],strtotime('+3 months'),'/');
    setcookie('nachname',$prow['nachname'],strtotime('+3 months'),'/');
    setcookie('speichern',' checked',strtotime('+3 months'),'/');
   }
   if($c) $autologin = $_COOKIE['autologin'];
   elseif(isset($_POST['autologin'])) $autologin = $_POST['autologin'];
   else $autologin = false;
   if($autologin)setcookie('autologin',' checked',strtotime('+3 months'),'/');
   else setcookie('autologin','',0,'/');
   if(isset($_POST['origin']) && $_POST['origin']!='/logout.php') $origin = $_POST['origin'];
   else $origin = './';
   redirect($origin);
  }
  else{
   mysql_close($mc);
   if($anz > 1){
    $inhalt = '<p>Der Benutzername ist nicht eindeutig.</p>';
   }
   else{
    $inhalt = '<p>Der Benutzername oder das Passwort sind falsch. <a href="'.$GLOBALS['root'].'benutzer/neu_passwd.php?vorname='.($c?$_COOKIE['vorname']:$_POST['vorname']).'&nachname='.($c?$_COOKIE['nachname']:$_POST['nachname']).'">Passwort vergessen?</a></p>';
    $inhalt.= get_anmeldung_link();
   }
   return $inhalt;
  }
 }

 // rekursive Funktion, stellt Strings '../' voran
 // um relative Pfade zu korrigieren
 function add_subdir($m){
  if(is_array($m)){
   foreach($m as $index => $value){
    $m[$index] = add_subdir($value);
   }
  }
  else{
   $m = '../'.$m;
  }
  return $m;
 }

 // wandelt ein Standarddatum (yyyy-mm-dd hh:ii:ss)
 // in gewohntes Format (hh:ii dd.mm.yy)
 function dt2datum($dt,$jl=2,$s=0){
  if($dt){
   $datum = substr($dt,8,2).'.'.substr($dt,5,2).'.'.substr($dt,4-$jl,$jl);
   if(strlen($dt)>10){
    $datum.= ' '.substr($dt,11,2).':'.substr($dt,14,2);
    if($s){
     $datum.= ':'.substr($dt,17,2);
    }
   }
   return $datum;
  }
 }

 // dt2datum() und fügt das Standarddatum als title hinzu
 function htmlformat_datum($dt,$jl=2,$s=0){
  return '<span title="'.$dt.'">'.dt2datum($dt,$jl,$s).'</span>';
 }

 // htmlformat_datum() und fettgedruckt, falls jünger als der letzte Login
 function htmlformat_datum_neu($dt){
  if($dt>$_SESSION['last_login']){
   $b = '<b class="datum_neu">';
   $be = '</b>';
  }
  else{
   $b = '';
   $be = '';
  }
  return $b.htmlformat_datum($dt).$be;
 }

 // htmlformat_datum() und fettgedruckt, falls in den nächsten 24 Stunden
 function htmlformat_datum_dringend($dt){
  if(substr($dt,0,10) < date('Y-m-d',strtotime('+1 days'))){
   $b = '<b>';
   $be = '</b>';
  }
  else{
   $b = '';
   $be = '';
  }
  return $b.htmlformat_datum($dt).$be;
 }

 // gibt den HTML-Code für ein Symbol zurück
 function htmlformat_symbol($name,$titel=0,$end='.gif'){
  if(!$titel) $titel = $name;
  global $root;
  $v['%url%'] = $root.'img/'.$name.$end;
  $v['%titel%'] = $titel;
  return get_face($root.'symbol.html',$v);
 }

 // gibt eine Zeile einer Personenliste zurück
 function get_person_link($person,$gid,$file){
  return '<li><a href="'.$file.'?pid='.$person['id'].'">'.$person['nachname'].',&#160;'.$person['vorname'].'</a>'.($gid?' - <a href="rm_pg.php?pid='.$person['id'].'&gid='.$gid.'">'.htmlformat_symbol('rm','entfernen').'</a>':'').'</li>';
 }

 // gibt eine Personenliste zurück
 function get_personen_link($person,$gid=0,$file='view_person.php'){
  $list = '<ul>';
  for($i=0;$i<sizeof($person);$i++){
   $list.= get_person_link($person[$i],$gid,$file);
  }
  $list.= '</ul>';
  return $list;
 }

 // gibt eine Zeile einer Gruppenliste zurück
 function get_gruppe_link($file,$id,$name){
  return '<li><a href="'.$file.'?gid='.$id.'">'.$name.'</a></li>';
 }

 // gibt eine Gruppenliste zurück
 function get_gruppen_link($gruppe,$file='view_gruppe.php'){
  if(sizeof($gruppe)>0){
   $list = '<ul>';
   foreach($gruppe as $id => $name){
    $list.= get_gruppe_link($file,$id,$name);
   }
   $list.= '</ul>';
  }
  return $list;
 }

 // ergänzt den Namen einer Person
 function complete_name($person){
  if(isset($person['name']) && !isset($person['vorname']) && !isset($person['nachname'])){
   $namen = explode(' ',$person['name']);
   $l = sizeof($namen)-1;
   $person['nachname'] = $namen[$l];
   unset($namen[$l]);
   $person['vorname'] = implode(' ',$namen);
  }
  else $person['name'] = $person['vorname'].' '.$person['nachname'];
  return $person;
 }

 // je nach den in in $p['opt'] gesetzten Bits werden Informationen zurückgegeben
 function filter_person($p){
  $public = decbin($p['opt']);
  while(strlen($public)<8)$public='0'.$public;
  $person['id'] = $p['id'];
  $person['vorname'] = $p['vorname'];
  $person['nachname']= $p['nachname'];
  if(isset($p['nk'])) $person['nk'] = $p['nk'];
  if($public[7])$person['gebdat']=$p['gebdat'];
  if($public[6])$person['mail']=$p['mail'];
  if($public[5])$person['icq']=$p['icq'];
  if($public[4])$person['pic']=$p['pic'];
  return $person;
 }

 // holt Informationen über eine Person aus der Datenbank
 function get_person($pid,$vorname=0,$nachname=0,$filter=1){
  $mc = get_mc();
  $personenrow = mysql_query('select id,vorname,nachname,nk,gebdat,mail,icq,opt,scr_wait,scr_delay from person where '.($pid?'id="'.$pid.'"':'vorname="'.text2html($vorname).'" and nachname="'.text2html($nachname).'"'));
  mysql_close($mc);
  if(mysql_num_rows($personenrow)>1){
   return 'Es wurde mehr als eine Person gefunden.';
  }
  else{
   if($p=mysql_fetch_array($personenrow)){
    if($filter){
     $person = filter_person($p);
    }
    else{
     $person = $p;
     $person['opt'] = decbin($person['opt']);
     while(strlen($person['opt'])<8)
      $person['opt'] = '0'.$person['opt'];
    }
    $person = complete_name($person);
    return $person;
   }
  }
 }

 // gibt alle Personen [einer Gruppe] zurück
 function get_personen($gid=0,$buchstabe=0){
  $person = array();
  $query = 'select person.id,person.vorname,person.nachname';
  $query.= ' from person';
  if($gid)
   $query.= ',pg where person.id=pg.pid and pg.gid="'.$gid.'"';
  if($buchstabe){
   if($gid) $query.= ' and';
   else $query.= ' where';
   if($buchstabe == '#') $query.= ' person.nachname regexp "^[0-9]"';
   else $query.= ' person.nachname like "'.$buchstabe.'%" or person.nachname like "&'.$buchstabe.'uml;%"';
  }
  $query.= ' order by nachname';
  $mc = get_mc();
  $personen = mysql_query($query);
  mysql_close($mc);
  while(list($p['id'],$p['vorname'],$p['nachname']) = mysql_fetch_row($personen)){
   $p = complete_name($p);
   $person[] = $p;
  }
  return $person;
 }

 // gibt Informationen über eine Gruppe zurück
 function get_gruppe($gid){
  $mc = get_mc();
  $gruppenrow = mysql_query('select gruppe.id,gruppe.name,gruppe.dsc,gruppe.notiz,gruppe.zensuren,person.id as lid,person.vorname as lvorname,person.nachname as lnachname from gruppe,person where gruppe.id="'.$gid.'" and gruppe.leiter=person.id');
  $stunden = mysql_query('select id,tag,zeit from stunde where gid="'.$gid.'" order by tag,zeit');
  mysql_close($mc);
  $gruppe = mysql_fetch_array($gruppenrow);
  if(isset($gruppe['id'])){
   $gruppe['stunde'] = array();
   while(list($id,$tag,$zeit) = mysql_fetch_row($stunden)){
    $gruppe['stunde'][$id]['tag'] = $tag;
    $gruppe['stunde'][$id]['zeit'] = $zeit;
   }
  }
  return $gruppe;
 }

 // gibt alle Gruppen [einer Person] zurück
 function get_gruppen($pid=0,$lid=0,$buchstabe=0){
  $query = 'select gruppe.id,gruppe.name from gruppe';
  if($pid)
   $query.= ',pg where gruppe.id=pg.gid and pg.pid="'.$pid.'"';
  else
   if($lid)
    $query.= ' where gruppe.leiter="'.$lid.'"';
  if($buchstabe){
   if($pid || $lid) $query.= ' and';
   else $query.= ' where';
   if($buchstabe == '#') $query.= ' name regexp "^[0-9]"';
   else $query.= ' name like "'.$buchstabe.'%" or name like "&'.$buchstabe.'uml;%"';
  }
  $query.= ' order by name';
  $mc = get_mc();
  $gruppen = mysql_query($query);
  mysql_close($mc);
  while($g = mysql_fetch_row($gruppen)){
   $gruppe[$g[0]] = $g[1];
  }
  return $gruppe;
 }

 // gibt alle Informationen über einen beantragten Account zurück
 function get_neu_account(){
  $mc = get_mc();
  $accounts = mysql_query('select id,passwd,vorname,nachname,gebdat,mail from neu_account order by nachname,vorname');
  mysql_close($mc);
  $account = array();
  while($a = mysql_fetch_row($accounts)){
   $account[] = $a;
  }
  return $account;
 }

 // gibt alle beantragten Mitgliedschaften wieder
 function get_neu_pg($pid){
  $q = 'select gruppe.id as gid,gruppe.name as gname,person.id as pid,person.vorname as pvorname,person.nachname as pnachname';
  $q.= ' from neu_pg,gruppe,person';
  $q.= ' where neu_pg.gid=gruppe.id';
  $q.= '  and gruppe.leiter="'.$pid.'"';
  $q.= '  and neu_pg.pid=person.id';
  $q.= ' order by gruppe.name,person.nachname,person.vorname';
  $mc = get_mc();
  $pgs = mysql_query($q);
  mysql_close($mc);
  $pg = array();
  while($a = mysql_fetch_array($pgs)){
   $pg[] = $a;
  }
  return $pg;
 }

 // gibt ein Select-Feld zurück, das nach Zahlen fragt
 function get_select_int($name,$start,$end,$value){
  $select = '<select name="'.$name.'">';
  for ($i=$start;$i<$end;$i++){
   $select.= '<option value="'.$i.'"';
   if ($i == $value) $select.= ' selected';
   $select.= '>'.$i.'</option>';
  }
  $select.= '</select>';
  return $select;
 }

 function find_name($typ,$name,$pgid=false){
  $query['person'] = 'select person.id,concat(person.vorname," ",person.nachname) from person';
  if($pgid) $query['person'].= ',pg';
  $query['person'].= ' where (concat(person.vorname," ",person.nachname) like "%'.$name.'%"';
  $query['person'].= ' or concat(person.nachname," ",person.vorname) like "%'.$name.'%")';
  if($pgid) $query['person'].= ' and person.id=pg.pid and pg.gid="'.$pgid.'"';
  $query['person'].= ' order by person.vorname,person.nachname';
  $query['gruppe'] = 'select gruppe.id,gruppe.name from gruppe';
  if($pgid) $query['gruppe'].= ',pg';
  $query['gruppe'].= ' where gruppe.name like "%'.$name.'%"';
  if($pgid) $query['gruppe'].= ' and gruppe.id=pg.gid and pg.pid="'.$pgid.'"';
  $query['gruppe'].= ' order by gruppe.name';
  $ids = array();
  get_mc();
  $typ_rows = mysql_query($query[$typ]);
  mysql_close();
  while(list($id,$name) = mysql_fetch_row($typ_rows)) $ids[$id] = $name;
  return $ids;
 }

 // verarbeitet Benutzerangaben zu gesuchten Personen oder Gruppen
 function manage_ids(){
  $status = 0;
  $typ = '';
  $ids = array();
  $typen = array('person','gruppe','Person','Gruppe');
  if(isset($_POST['typ']) && in_array($_POST['typ'],$typen)){
   $typ = strtolower($_POST['typ']);
   if(isset($_POST['ids'])){
    $status = 2;
    $ids = $_POST['ids'];
   }
   elseif(isset($_POST['name'])){
    $status = 1;
    $name = $_POST['name'];
    $ids = find_name($typ,$_POST['name']);
   }
  }
  if(isset($_GET['typ']) && in_array($_GET['typ'],$typen) && isset($_GET['id'])){
   $typ = strtolower($_GET['typ']);
   $func = 'get_'.$typ;
   $typ_info = $func($_GET['id']);
   if(sizeof($typ_info)>0){
    $status = 2;
    $ids = array($typ_info['id'] => $typ_info['name']);
   }
  }
  return array($status,$typ,$ids);
 }

 function ask_ids($typ,$ids,$v='ids'){
  $input = '<input type="hidden" name="typ" value="'.$typ.'" />';
  if(sizeof($ids)>0){
   foreach($ids as $id => $name){
    $input.= '<input type="checkbox" name="'.$v.'['.$id.']" value="'.$name.'" /> '.$name.'<br>';
   }
  }
  return $input;
 }

 // gibt ein Formular zur eingabe eines Namens ein (Person oder Gruppe)
 function ask_name($name='Name',$file='neu.php'){
  $v['%name%'] = $name;
  $v['%file%'] = $file;
  return get_face($GLOBALS['root'].'form_name.html',$v);
 }

 // gibt erlaubte Tags formatiert zurück
 function htmlformat_code_html(){
  $tags = '';
  foreach($GLOBALS['code_html'] as $c => $html){
   $t = '['.$c.'][/'.$c.']';
   $tags.= '<nobr><span onClick="textarea_insert('."'".$c."'".');"> '.$t.'</span></nobr> ';
  }
  $tags.= '<img src="'.$GLOBALS['root'].'img/rm.gif" border=0 alt="rm" title="Text L&ouml;schen" onClick="window.document.getElementById('."'".'edit_text'."'".').value = '."''".';"> ';
  $tags.= '<a href="'.$GLOBALS['root'].'dokumentation/faq.php#texte" title="Hilfe">?</a>';
  return $tags;
 }

 function htmlformat_textarea($text='',$cols=50,$rows=15){
  $v['%width%'] = 10*$cols.'px';
  $v['%code%'] = htmlformat_code_html();
  $v['%cols%'] = $cols;
  $v['%rows%'] = $rows;
  $v['%text%'] = html2textarea($text);
  return get_face($GLOBALS['root'].'textarea_format.html',$v);
 }

 // rekursive Funktion; überprüft, ob ein Wert in einem Array enthalten ist
 function is_valid($valid,$v){
  $e = 0;
  if(is_array($valid)){
   foreach($valid as $index => $value){
    if(is_valid($value,$v))
     $e=1;
   }
  }
  else $e = ($valid==$v);
  return $e;
 }

 // prüft, ob eine Personen-ID in einer List enhalten ist
 function ist_mitglied($mitglied,$pid){
  $e = 0;
  for($i=0;$i<sizeof($mitglied);$i++){
   if($mitglied[$i]['id']==$pid)
    $e = 1;
  }
  return $e;
 }

 //Gibt einen vollständigen <img> Tag zurück, falls unter der ID $datei eine Datei vorhanden ist
 function get_avatar_link($datei, $zusatz_tags='')
 {
 $pfad_intern = $GLOBALS['img_person_dir']['intern'];
 $pfad_extern = $GLOBALS['img_person_dir']['extern'];
 
 if (file_exists($pfad_intern.$datei.'.jpg')) $datei .= '.jpg';
 elseif (file_exists($pfad_intern.$datei.'.gif')) $datei .= '.gif';
 else $datei = '';

 if ($datei != '')
 {
 $pic_info = GetImageSize($pfad_intern.$datei);
 $return = "<img src=\"";
 $return .= $pfad_extern.$datei;
 $return .= "\" ".$pic_info[3].">";
 $return .= $zusatz_tags; //wird nur bei vorhandenem Bild angefügt
 }
 else $return = '';

 return $return;
 }

?>
