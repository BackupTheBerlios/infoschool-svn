<?php/* * This file is part of Infoschool - a web based school intranet. * Copyright (C) 2004 Maikel Linke */  class message {  var $data = array();  var $to = array();      function message($data=array()) {   $this->set_data($data);  }    function set_data($data) {   $this->data = $data;  }    function load($id) {   global $db;   $query = 'messages.author as author_id,             person.first_name as author_first_name,             person.last_name as author_last_name,             messages.text            from messages            left join person on             messages.author=person.id            left join messages_to on             messages.id=messages_to.message            where             messages.id="'.$id.'" and             messages_to.person="'.$_SESSION['userid'].'"            ';   $db->select($query);   if ($db->num_rows == 1) {    $this->data = $db->data[0];   }  }    function load_to() {   global $db;   $query = 'person.id,              person.first_name,              person.last_name            from messages_to            left join person on             messages_to.person=person.id            where messages_to.message="'.$this->data['id'].'"';   $db->select($query);   $this->to = $db->data;   }    function format() {   $fdata = $this->data;   $fdata['text_html'] = html_br($fdata['text']);   $fdata['created_html'] = local_date($fdata['created'],'ymdHi');   $fdata['author_first_name_html'] = mask_html($fdata['author_first_name']);   $fdata['author_last_name_html'] = mask_html($fdata['author_last_name']);   $to_list = array();   $seperator = array();   foreach ($this->to as $i => $to) {    $to['first_name'] = mask_html($to['first_name']);    $to['last_name'] = mask_html($to['last_name']);    $to['seperator'] = $seperator;    $seperator = array(array());    $to_list[] = $to;   }   $fdata['to'] = $to_list;      $menu = array();   if (isset($fdata['new'])) {    $mark = 'mark read';    if ($fdata['new'] == '0') $mark = 'mark unread';    $menu_var['mark_un_read'] = $mark;    $delete = 'Delete';    if ($fdata['active'] == '0') $delete = 'Undelete';    $menu_var['un_delete'] = $delete;    $menu[0] = $menu_var;   }      $fdata['menu'] = $menu;      $tmpl = new tmpl('message.html',$fdata);   $this->output = $tmpl->fdata;  }    function create($text,$persons,$groups) {   $data['text'] = $text;   $data['text_slashes'] = addslashes($text);   $data['created'] = date('Y-m-d H:i:s');   $data['author_first_name'] = $_SESSION['first_name'];   $data['author_last_name'] = $_SESSION['last_name'];   foreach ($groups as $id => $name) {    $group = new group($id);    foreach ($group->members as $i => $member) {     $persons[$member['member_id']] = $member;    }   }   foreach ($persons as $id => $arr) {    $person = new person();    $person->load($id);    $persons[$id] = $person->data;   }   $this->to = $persons;   $this->set_data($data);  }    function insert() {   global $db;   $query = 'messages (author, created, text) values (              "'.$_SESSION['userid'].'",              now(),              "'.$this->data['text_slashes'].'"             )';   $db->insert($query);   $message_id = $db->insert_id;   $author = new person();   $author->load($_SESSION['userid']);   $author_name = $author->data['first_name'].' '.$author->data['last_name'];   $tmpl_mail_subject = new tmpl('mail_subject.txt',array('author'=>$author_name));   $mail_subject = $tmpl_mail_subject->fdata;   $mail_vars = $this->data;   $mail_vars['text'] = stripslashes($mail_vars['text']);   $tmpl_mail_text = new tmpl('mail.txt',$mail_vars);   $mail_text = $tmpl_mail_text->fdata;   $mail = new mail();   $mail->set_subject($mail_subject);   if ($author->data['public_mail']) {    $from = '"'.$author_name.'" <'.$author->data['public_mail'].'>';    $mail->set_header($from);   }    foreach ($this->to as $person_id => $person) {    $query = 'messages_to (message, person) values (               "'.$message_id.'",               "'.$person_id.'"              )';    $db->insert($query);    if ($person['opt'] & 16) {     $to_name = $person['first_name'].' '.$person['last_name'];     $mail->set_to($person['mail'],$to_name);     $mail->set_data($mail_text);     $mail->send();    }   }  }   } ?>